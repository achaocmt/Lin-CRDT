%!TEX root = draft.tex
%\newcommand{\seqPQ}{\mathsf{SeqPQ}}

\section{Proving Distributed Linearizability}
\label{sec:proving distributed linearizability} 

In this section, we propose our approach for proving distributed linearizability for CRDT implementations. Our proof is done by proving a invariant. 


\subsection{Proof Strategy of State-based CRDT}
\label{subsec:proof strategy of operation-based CRDT} 

Given a state-based CRDT object $\mathit{obj}$ and a sequential specification $\mathit{spec}$, we need to construct a invariant $\mathit{inv}((R, T), h, \mathit{lin})$ that satisfies the following properties of $\mathit{inv}$:

\begin{itemize}
\setlength{\itemsep}{0.5pt}
\item[-] $(R, T)$ is a configuration of $\llbracket \mathit{obj} \rrbracket_s$.

\item[-] $h$ is distributed linearizable w.r.t $\mathit{spec}$ and $\mathit{lin}$ is a linearization. 

\item[-] $\mathit{inv}$ holds initially: $\mathit{inv}((R_0,T_0),\epsilon,\emptyset)$ holds, where $(R_0, T_0)$ is the initial configuration of $\llbracket \mathit{obj} \rrbracket_s$.

\item[-] $\mathit{inv}$ is a transition invariant:

    \begin{itemize}
    \setlength{\itemsep}{0.5pt}
    \item[-] If $\mathit{inv}((R, T), h, \mathit{lin})$ and $(R, T) {\xrightarrow{\mathit{do}(m, a, b, r, \mathit{mid})}} (R', T')$ or $(R, T) {\xrightarrow{\mathit{do}(m, a, b, r)}} (R', T')$, then there exists $\mathit{lin}'$, such that $\mathit{inv}((R', T'), h \otimes (m(a) \Rightarrow b, i, \mathit{obj}), \mathit{lin}')$ holds.

        Here $i$ is the operation identifier of the newly generated $\mathit{do}$ action. $h \otimes (m(a) \Rightarrow b,i,\mathit{obj})$ extends $h$ with operation $i$ as follows: make $i$ the maximum w.r.t $\mathit{ro}$ among operations of replica $r$; for any operation $o$ that is either delivered to replica $r$ or visible to some operation of replica $r$ in $h$, make $o$ visible to $i$. 

    \item[-] If $(R, T) {\xrightarrow{\mathit{receive}(\mathit{mid},r)}} (R', T')$, then $\mathit{inv}((R', T'),h \cup (\mathit{mid},r),\mathit{lin})$ holds.
    \end{itemize}
\end{itemize} 

Here we slightly change the notion of history and make history also record tuples $(j,r)$ that represents that a message $j$ is delivered to replica $r$. This does not influence the definition of distributed linearizablity of a history w.r.t a sequential specification. $\mathit{inv}((R, T),h,\mathit{lin})$ represents that $h$ is a history corresponds to $(R,T)$ and $\mathit{lin}$ is a linearization of $h$. A invariant $\mathit{inv}$ satisfies above properties is called invariant of state-based CRDT. The following lemma states that the existence of such invariant implies distributed linearizability. 

%and we prove it in Appendix \ref{subsec:appendix proof of Lemma invariant of state-based CRDT implies distributed linearizability}.

\begin{lemma}
\label{lemma:invariant of state-based CRDT implies distributed linearizability} 
If there exists a invariant $\mathit{inv}$ of state-based CRDT for object $\mathit{obj}$ and sequential specification $\mathit{spec}$, then each history of $\mathit{history}(\llbracket \mathit{obj} \rrbracket_s)$ is distributed linearizable w.r.t $\mathit{spec}$. 
\end{lemma} 

\begin {proof}  
This lemma can be obviously checked by induction: given an execution $l=\alpha_1 \cdot \ldots \cdot \alpha_n$, for each $1 \leq k \leq n$, we have $\mathit{inv}((R_k,T_k),h_k,\mathit{lin}_k)$ holds, $(R_k,T_k)$ be the current configuration after executing $\alpha_1 \cdot \ldots \cdot \alpha_k$, $h$ is the history of $\alpha_1 \cdot \ldots \cdot \alpha_k$ and also stores the delivery relation, and $\mathit{lin}_k$ is the linearization of $h_k$. This completes the proof of this lemma. $\qed$ 
\end {proof}




For many state-based CRDT implementations, $\mathit{inv}((R, T), h, \mathit{lin})$ is the conjunction of the following conditions: 

\begin{itemize}
\setlength{\itemsep}{0.5pt} 
\item[-] The message content in $T$ for each update operations of $h$. 
 
\item[-] $\forall r$, $C(r) = \mathit{apply}(\mathit{lin},\mathit{vis}^{-1}(r),T)$.  
\end{itemize} 

The function $\mathit{apply}$ is defined as follows: Let the sequence $\alpha_1 \cdot \ldots \cdot \alpha_k$ be the projection of $\mathit{lin}$ into update operations that is either of replica $r$, or visible to some operation of replica $r$, or delivered to replica $r$. Then, $\mathit{apply}(\mathit{lin},\mathit{vis}^{-1}(r),T)$ is a local state obtained from the initial local state as follows: for each $1 \leq i \leq k$, if $\alpha_i$ is a update operation, then apply the message generated by $\alpha_i$ in $T$; otherwise, do nothing. 

Let us give the invariants of state-based PN-counter and state-based multi-value register as follows:  

\begin{example}[correctness of state-based PN-counter]
\label{example:correctness of state-based PN-counter} 

For state-based PN-counter, $\mathit{inv}((R, T), h, \mathit{lin})$ is defined as follows: 

\begin{itemize}
\setlength{\itemsep}{0.5pt}
\item[-] The message content of a update operation $o$ is $(P,N)$: for each replica $r$, $P[r]$ is the number of $\mathit{inc}$ operation visible to operations of replica $r$ or delivered to replica $r$ in $h$, and $N[r]$ is the number of $\mathit{dec}$ operation visible to operations of replica $r$ or delivered to replica $r$ in $h$.

\item[-] $\forall r$, $C(r) = \mathit{apply}(\mathit{lin},\mathit{vis}^{-1}(r),T)$. 
\end{itemize} 
\end{example} 

\begin{example}[correctness of state-based Multi-value Register]
\label{example:correctness of state-based multi-value register}

For state-based multi-value register, $\mathit{inv}((R, T), h, \mathit{lin})$ is defined as follows:

\begin{itemize}
\setlength{\itemsep}{0.5pt}
\item[-] Given a update operation $o$, the message content of $o$ is a set $S$, such that 

    \begin{itemize}
    \setlength{\itemsep}{0.5pt}
    \item[-] Let $S_1$ be the set of maximal operations operations visible to $o$.  
    \end{itemize}

\item[-] $\forall r$, $C(r) = \mathit{apply}(\mathit{lin},\mathit{vis}^{-1}(r),T)$.
\end{itemize}
\end{example} 




The detailed proof of the state-based PN-set can be found in Appendix \ref{subsec:appendix proof of state-based PN-set}. 

The detailed proof of the state-based multi-value register can be found in Appendix \ref{subsec:appendix proof of state-based multi-value register}.


 



%%% Local Variables:
%%% mode: latex
%%% TeX-master: "draft"
%%% End:
